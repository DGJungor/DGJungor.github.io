---
title: MySQL大表优化方案(二)
date: 2018-03-13 09:18:11
tags: [数据库,MySQL]
categories: 数据库
---

### 垂直拆分

垂直分库是根据数据库里面的数据表的相关性进行拆分，比如：一个数据库里面既存在用户数据，又存在订单数据，那么垂直拆分可以把用户数据放到用户库、把订单数据放到订单库。垂直分表是对数据表进行垂直拆分的一种方式，常见的是把一个多字段的大表按常用字段和非常用字段进行拆分，每个表里面的数据记录数一般情况下是相同的，只是字段不一样，使用主键关联

{% asset_img 1.png %}


#### 垂直拆分的优点是：

* 可以使得行数据变小，一个数据块(Block)就能存放更多的数据，在查询时就会减少I/O次数(每次查询时读取的Block 就少)
* 可以达到最大化利用Cache的目的，具体在垂直拆分的时候可以将不常变的字段放一起，将经常改变的放一起
* 数据维护简单


#### 缺点

* 主键出现冗余，需要管理冗余列
* 会引起表连接JOIN操作（增加CPU开销）可以通过在业务服务器上进行join来减少数据库压力
* 依然存在单表数据量过大的问题（需要水平拆分）
* 事务处理复杂

<!-- more -->
### 水平拆分

概述
水平拆分是通过某种策略将数据分片来存储，分库内分表和分库两部分，每片数据会分散到不同的MySQL表或库，达到分布式的效果，能够支持非常大的数据量。前面的表分区本质上也是一种特殊的库内分表

库内分表，仅仅是单纯的解决了单一表数据过大的问题，由于没有把表的数据分布到不同的机器上，因此对于减轻MySQL服务器的压力来说，并没有太大的作用，大家还是竞争同一个物理机上的IO、CPU、网络，这个就要通过分库来解决

{% asset_img 2.png %}

实际情况中往往会是垂直拆分和水平拆分的结合，即将Users_A_M和Users_N_Z再拆成Users和UserExtras，这样一共四张表


水平拆分的优点是:

* 不存在单库大数据和高并发的性能瓶颈
* 应用端改造较少
* 提高了系统的稳定性和负载能力


缺点是：

* 分片事务一致性难以解决
* 跨节点Join性能差，逻辑复杂
* 数据多次扩展难度跟维护量极大


分片原则:

* 能不分就不分，参考单表优化
* 分片数量尽量少，分片尽量均匀分布在多个数据结点上，因为一个查询SQL跨分片越多，则总体性能越差，虽然要好于所有数据在一个分片的结果，只在必要的时候进行扩容，增加分片数量
* 分片规则需要慎重选择做好提前规划，分片规则的选择，需要考虑数据的增长模式，数据的访问模式，分片关联性问题，以及分片扩容问题，最近的分片策略为范围分片，枚举分片，一致性Hash分片，这几种分片都有利于扩容
* 尽量不要在一个事务中的SQL跨越多个分片，分布式事务一直是个不好处理的问题
* 查询条件尽量优化，尽量避免Select * 的方式，大量数据结果集下，会消耗大量带宽和CPU资源，查询尽量避免返回大量结果集，并且尽量为频繁使用的查询语句建立索引。
* 通过数据冗余和表分区赖降低跨库Join的可能


这里特别强调一下分片规则的选择问题，如果某个表的数据有明显的时间特征，比如订单、交易记录等，则他们通常比较合适用时间范围分片，因为具有时效性的数据，我们往往关注其近期的数据，查询条件中往往带有时间字段进行过滤，比较好的方案是，当前活跃的数据，采用跨度比较短的时间段进行分片，而历史性的数据，则采用比较长的跨度存储。

总体上来说，分片的选择是取决于最频繁的查询SQL的条件，因为不带任何Where语句的查询SQL，会遍历所有的分片，性能相对最差，因此这种SQL越多，对系统的影响越大，所以我们要尽量避免这种SQL的产生。


解决方案
由于水平拆分牵涉的逻辑比较复杂，当前也有了不少比较成熟的解决方案。这些方案分为两大类：客户端架构和代理架构。

### 客户端架构
通过修改数据访问层，如JDBC、Data Source、MyBatis，通过配置来管理多个数据源，直连数据库，并在模块内完成数据的分片整合，一般以Jar包的方式呈现

{% asset_img 3.png %}
可以看到分片的实现是和应用服务器在一起的，通过修改Spring JDBC层来实现

客户端架构的优点是：

* 应用直连数据库，降低外围系统依赖所带来的宕机风险
* 集成成本低，无需额外运维的组件


缺点是：

* 限于只能在数据库访问层上做文章，扩展性一般，对于比较复杂的系统可能会力不从心
* 将分片逻辑的压力放在应用服务器上，造成额外风险


### 代理架构
通过独立的中间件来统一管理所有数据源和数据分片整合，后端数据库集群对前端应用程序透明，需要独立部署和运维代理组件

{% asset_img 4.png %}

代理组件为了分流和防止单点，一般以集群形式存在，同时可能需要Zookeeper之类的服务组件来管理

代理架构的优点是：

* 能够处理非常复杂的需求，不受数据库访问层原来实现的限制，扩展性强
* 对于应用服务器透明且没有增加任何额外负载


缺点是：

* 需部署和运维独立的代理中间件，成本高
* 应用需经过代理来连接数据库，网络上多了一跳，性能有损失且有额外风险
